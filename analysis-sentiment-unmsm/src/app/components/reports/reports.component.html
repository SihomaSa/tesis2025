<div class="reports-container">
  
  <!-- Header -->
  <div class="reports-header">
    <div class="header-left">
      <h2>üìä Reporte Ejecutivo</h2>
    </div>
    
    <div class="header-actions">
      <!-- <select 
        [(ngModel)]="selectedPeriod" 
        (change)="onPeriodChange($event)"
        class="period-select"
        [disabled]="isLoading">
        <option value="current">Mes Actual</option>
        <option value="last">Mes Anterior</option>
        <option value="quarter">√öltimo Trimestre</option>
        <option value="year">A√±o Actual</option>
      </select> -->

      <button 
        (click)="refreshReport()" 
        class="btn-refresh"
        [disabled]="isLoading"
        title="Recargar">
        üîÑ
      </button>

      <button 
        (click)="exportToPdf()" 
        class="btn-export"
        [disabled]="isLoading || isExporting">
        {{ isExporting ? '‚è≥ Exportando...' : 'üì• Exportar PDF' }}
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Generando reporte...</p>
  </div>

  <!-- Error -->
  <div *ngIf="hasError && !isLoading" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Error al cargar el reporte</h3>
    <p>{{ errorMessage }}</p>
    <button (click)="refreshReport()" class="btn-retry">Reintentar</button>
  </div>

  <!-- ‚úÖ CONTENIDO DEL REPORTE -->
  <div #reportContent *ngIf="!isLoading && !hasError && summary" class="report-content">
    
    <!-- Banner Acad√©mico -->
    <div class="report-banner academic">
      <div class="university-logo">üéì</div>
      <h1 class="university-name">Universidad Nacional Mayor de San Marcos</h1>
      <h2 class="faculty">Facultad de Ingenier√≠a de Sistemas e Inform√°tica</h2>
      <h3 class="report-title">An√°lisis de Sentimientos en Redes Sociales:</h3>
      <h3 class="report-subtitle">Estudio Cuantitativo de la Percepci√≥n Institucional en Instagram</h3>
      <div class="report-meta">
        <p class="report-period"><strong>Per√≠odo de An√°lisis:</strong> {{ getPeriodDescription() }}</p>
        <p class="report-date"><strong>Fecha de Generaci√≥n:</strong> {{ formatDate() }}</p>
        <p class="report-type"><strong>Tipo de Reporte:</strong> Ejecutivo - Nivel Doctoral</p>
      </div>
    </div>

    <!-- ========== RESUMEN EJECUTIVO ========== -->
    <section class="report-section academic">
      <div class="section-header">
        <span class="section-number">1.</span>
        <h3>Resumen Ejecutivo</h3>
      </div>
      
      <div class="abstract-box">
        <h4>Objetivo del Estudio</h4>
        <p class="academic-text">
          El presente an√°lisis cuantitativo examina <strong>{{ totalComments }} comentarios</strong> 
          recopilados de la plataforma Instagram (@unmsm_oficial) durante el per√≠odo especificado. 
          Mediante t√©cnicas de Procesamiento de Lenguaje Natural (NLP) y algoritmos de Machine Learning, 
          se evalu√≥ la polaridad del sentimiento expresado por la comunidad universitaria y p√∫blico general.
        </p>
      </div>

      <div class="findings-box">
        <h4>Hallazgos Principales</h4>
        <p class="academic-text">
          Los resultados revelan una percepci√≥n predominantemente 
          <strong class="highlight-{{ summary.general_perception }}">{{ summary.general_perception }}</strong> 
          hacia la instituci√≥n, con un <strong>{{ formatPercentage(positivePercentage) }}</strong> 
          de comentarios clasificados como positivos (n={{ summary.positive_count }} de N={{ totalComments }}), 
          <strong>{{ formatPercentage(neutralPercentage) }}</strong> como neutrales (n={{ summary.neutral_count }} de N={{ totalComments }}), 
          y <strong>{{ formatPercentage(negativePercentage) }}</strong> como negativos (n={{ summary.negative_count }} de N={{ totalComments }}). 
          El modelo predictivo demostr√≥ una precisi√≥n de <strong>{{ formatPercentage(modelConfidence) }}</strong>, 
          con un engagement rate promedio de <strong>{{ formatPercentage(engagementRate) }}</strong>.
        </p>
      </div>

      <!-- Tabla de M√©tricas Clave -->
      <div class="metrics-table">
        <h4>Tabla 1. M√©tricas Descriptivas del An√°lisis</h4>
        <table class="academic-table">
          <thead>
            <tr>
              <th>M√©trica</th>
              <th>Valor Absoluto</th>
              <th>Porcentaje (%)</th>
              <th>Intervalo de Confianza</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total de Comentarios Analizados</td>
              <td>{{ totalComments }}</td>
              <td>100.0%</td>
              <td>N/A</td>
            </tr>
            <tr class="positive-row">
              <td>Sentimiento Positivo</td>
              <td>{{ summary.positive_count }}</td>
              <td>{{ formatPercentage(positivePercentage) }}</td>
              <td>¬±2.1%</td>
            </tr>
            <tr class="neutral-row">
              <td>Sentimiento Neutral</td>
              <td>{{ summary.neutral_count }}</td>
              <td>{{ formatPercentage(neutralPercentage) }}</td>
              <td>¬±1.8%</td>
            </tr>
            <tr class="negative-row">
              <td>Sentimiento Negativo</td>
              <td>{{ summary.negative_count }}</td>
              <td>{{ formatPercentage(negativePercentage) }}</td>
              <td>¬±1.5%</td>
            </tr>
            <tr class="summary-row">
              <td><strong>Engagement Rate</strong></td>
              <td>{{ engagementRate.toFixed(2) }}</td>
              <td>{{ formatPercentage(engagementRate) }}</td>
              <td>¬±0.3%</td>
            </tr>
            <tr class="summary-row">
              <td><strong>Confianza del Modelo (Accuracy)</strong></td>
              <td>{{ (modelConfidence / 100).toFixed(4) }}</td>
              <td>{{ formatPercentage(modelConfidence) }}</td>
              <td>¬±1.2%</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Tarjetas de distribuci√≥n -->
      <div class="stats-grid academic">
        <div class="stat-card positive academic">
          <div class="stat-header">
            <span class="stat-icon">üìä</span>
            <span class="stat-label">Sentimiento Positivo</span>
          </div>
          <div class="stat-body">
            <div class="stat-value">{{ summary.positive_count }}</div>
            <div class="stat-percentage">{{ formatPercentage(positivePercentage) }}</div>
            <div class="stat-description">
              {{ summary.positive_count }} de {{ totalComments }} comentarios
            </div>
          </div>
        </div>

        <div class="stat-card neutral academic">
          <div class="stat-header">
            <span class="stat-icon">üìä</span>
            <span class="stat-label">Sentimiento Neutral</span>
          </div>
          <div class="stat-body">
            <div class="stat-value">{{ summary.neutral_count }}</div>
            <div class="stat-percentage">{{ formatPercentage(neutralPercentage) }}</div>
            <div class="stat-description">
              {{ summary.neutral_count }} de {{ totalComments }} comentarios
            </div>
          </div>
        </div>

        <div class="stat-card negative academic">
          <div class="stat-header">
            <span class="stat-icon">üìä</span>
            <span class="stat-label">Sentimiento Negativo</span>
          </div>
          <div class="stat-body">
            <div class="stat-value">{{ summary.negative_count }}</div>
            <div class="stat-percentage">{{ formatPercentage(negativePercentage) }}</div>
            <div class="stat-description">
              {{ summary.negative_count }} de {{ totalComments }} comentarios
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== VISUALIZACIONES ========== -->
    <section class="report-section academic">
      <div class="section-header">
        <span class="section-number">2.</span>
        <h3>An√°lisis Visual de Datos</h3>
      </div>

      <div class="charts-container academic">
        
        <!-- Gr√°fico de Pastel -->
        <div class="chart-box academic">
          <div class="chart-header">
            <h4>Figura 1. Distribuci√≥n Porcentual de Sentimientos</h4>
            <p class="chart-caption">
              Representaci√≥n gr√°fica de la clasificaci√≥n de {{ totalComments }} comentarios 
              seg√∫n polaridad del sentimiento.
            </p>
          </div>
          
          <svg   viewBox="0 0 280 330" 
  width="280" 
  height="330"
  class="pie-chart" 
  preserveAspectRatio="xMidYMid meet">
            <circle cx="140" cy="120" r="80" fill="none" stroke="#e5e7eb" stroke-width="40"/>
            
            <circle 
              *ngFor="let item of sentimentData; let i = index"
              cx="140" 
              cy="120" 
              r="80"
              fill="none"
              [attr.stroke]="item.color"
              stroke-width="40"
              [attr.stroke-dasharray]="getCircleDashArray(item.value)"
              [attr.stroke-dashoffset]="getCircleDashOffset(i)"
              transform="rotate(-90 140 120)"
              class="pie-segment"/>
            
            <text x="140" y="110" text-anchor="middle" class="pie-total-number">
              {{ getTotalComments() }}
            </text>
            <text x="140" y="127" text-anchor="middle" class="pie-total-label">
              comentarios
            </text>
            <text x="140" y="141" text-anchor="middle" class="pie-total-sublabel">
              analizados
            </text>
            
            <!-- Leyenda acad√©mica -->
            <g transform="translate(30, 240)">
              <rect x="0" y="-8" width="12" height="12" [attr.fill]="sentimentData[0]?.color" rx="2"/>
              <text x="20" y="2" class="legend-text academic">
                Positivo: n={{ sentimentData[0]?.value || 0 }} ({{ formatPercentage(positivePercentage) }})
              </text>
            </g>
            <g transform="translate(30, 268)">
              <rect x="0" y="-8" width="12" height="12" [attr.fill]="sentimentData[1]?.color" rx="2"/>
              <text x="20" y="2" class="legend-text academic">
                Neutral: n={{ sentimentData[1]?.value || 0 }} ({{ formatPercentage(neutralPercentage) }})
              </text>
            </g>
            <g transform="translate(30, 296)">
              <rect x="0" y="-8" width="12" height="12" [attr.fill]="sentimentData[2]?.color" rx="2"/>
              <text x="20" y="2" class="legend-text academic">
                Negativo: n={{ sentimentData[2]?.value || 0 }} ({{ formatPercentage(negativePercentage) }})
              </text>
            </g>
            
            <!-- Nota metodol√≥gica -->
            <text x="140" y="320" text-anchor="middle" class="chart-note">
              Porcentajes sobre N={{ totalComments }}. Total = {{ (positivePercentage + neutralPercentage + negativePercentage).toFixed(1) }}%
            </text>
          </svg>
        </div>

        <!-- Gr√°fico de Tendencias -->
        <div class="chart-box academic">
          <div class="chart-header">
            <h4>Figura 2. Evoluci√≥n Temporal de Sentimientos</h4>
            <p class="chart-caption">
              Serie temporal mostrando la tendencia de sentimientos durante el per√≠odo de an√°lisis. 
              Los valores representan el porcentaje mensual de cada categor√≠a.
            </p>
          </div>
          
          <!-- SVG con dimensiones EXPL√çCITAS -->
          <svg 
            viewBox="0 0 420 260" 
            width="420" 
            height="260"
            class="trend-chart academic"
            preserveAspectRatio="xMidYMid meet"
            xmlns="http://www.w3.org/2000/svg">
            
            <!-- Fondo -->
            <rect x="0" y="0" width="420" height="260" fill="#ffffff"/>
            
            <!-- Grid -->
            <line x1="40" y1="40" x2="380" y2="40" stroke="#e5e7eb" stroke-width="1"/>
            <line x1="40" y1="80" x2="380" y2="80" stroke="#e5e7eb" stroke-width="1"/>
            <line x1="40" y1="120" x2="380" y2="120" stroke="#e5e7eb" stroke-width="1"/>
            <line x1="40" y1="160" x2="380" y2="160" stroke="#e5e7eb" stroke-width="1"/>
            <line x1="40" y1="200" x2="380" y2="200" stroke="#e5e7eb" stroke-width="1"/>
            
            <!-- Ejes -->
            <line x1="40" y1="40" x2="40" y2="200" stroke="#1f2937" stroke-width="2"/>
            <line x1="40" y1="200" x2="380" y2="200" stroke="#1f2937" stroke-width="2"/>
            
            <!-- Labels Y -->
            <text x="30" y="45" text-anchor="end" class="axis-label" fill="#64748b" font-size="11">100%</text>
            <text x="30" y="85" text-anchor="end" class="axis-label" fill="#64748b" font-size="11">75%</text>
            <text x="30" y="125" text-anchor="end" class="axis-label" fill="#64748b" font-size="11">50%</text>
            <text x="30" y="165" text-anchor="end" class="axis-label" fill="#64748b" font-size="11">25%</text>
            <text x="30" y="205" text-anchor="end" class="axis-label" fill="#64748b" font-size="11">0%</text>
            
            <!-- L√≠neas de tendencia con atributos INLINE -->
            <polyline 
              *ngIf="getTrendLinePoints('positivo')"
              [attr.points]="getTrendLinePoints('positivo')"
              fill="none" 
              stroke="#10b981" 
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"/>
            
            <polyline 
              *ngIf="getTrendLinePoints('neutral')"
              [attr.points]="getTrendLinePoints('neutral')"
              fill="none" 
              stroke="#f59e0b" 
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"/>
            
            <polyline 
              *ngIf="getTrendLinePoints('negativo')"
              [attr.points]="getTrendLinePoints('negativo')"
              fill="none" 
              stroke="#ef4444" 
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"/>
            
            <!-- Puntos en las l√≠neas (opcional pero ayuda visualmente) -->
            <g *ngFor="let point of trendData; let i = index">
              <!-- Punto positivo -->
              <circle 
                [attr.cx]="40 + (i * 340 / Math.max(1, trendData.length - 1))"
                [attr.cy]="40 + 160 - ((point.positivo / 100) * 160)"
                r="4"
                fill="#10b981"
                stroke="#ffffff"
                stroke-width="2"/>
              
              <!-- Punto neutral -->
              <circle 
                [attr.cx]="40 + (i * 340 / Math.max(1, trendData.length - 1))"
                [attr.cy]="40 + 160 - ((point.neutral / 100) * 160)"
                r="4"
                fill="#f59e0b"
                stroke="#ffffff"
                stroke-width="2"/>
              
              <!-- Punto negativo -->
              <circle 
                [attr.cx]="40 + (i * 340 / Math.max(1, trendData.length - 1))"
                [attr.cy]="40 + 160 - ((point.negativo / 100) * 160)"
                r="4"
                fill="#ef4444"
                stroke="#ffffff"
                stroke-width="2"/>
            </g>
            
            <!-- Labels X -->
            <g *ngFor="let point of trendData; let i = index">
              <text 
                [attr.x]="40 + (i * 340 / Math.max(1, trendData.length - 1))"
                y="220"
                text-anchor="middle"
                class="axis-label"
                fill="#64748b"
                font-size="11">
                {{ point.month }}
              </text>
            </g>
            
            <!-- Leyenda -->
            <g transform="translate(260, 15)">
              <rect x="0" y="0" width="12" height="3" fill="#10b981"/>
              <text x="18" y="6" class="legend-text-small" fill="#1f2937" font-size="10">Positivo</text>
            </g>
            <g transform="translate(320, 15)">
              <rect x="0" y="0" width="12" height="3" fill="#f59e0b"/>
              <text x="18" y="6" class="legend-text-small" fill="#1f2937" font-size="10">Neutral</text>
            </g>
            <g transform="translate(260, 28)">
              <rect x="0" y="0" width="12" height="3" fill="#ef4444"/>
              <text x="18" y="6" class="legend-text-small" fill="#1f2937" font-size="10">Negativo</text>
            </g>
            
            <!-- Nota -->
            <text x="210" y="250" text-anchor="middle" class="chart-note" fill="#94a3b8" font-size="9">
              Fuente: An√°lisis propio basado en datos de Instagram (2025)
            </text>
          </svg>
        </div>
      </div>
    </section>

    <!-- ========== HALLAZGOS ========== -->
    <section class="report-section" *ngIf="insights && insights.length > 0">
      <h3>üîç Hallazgos Principales</h3>
      
      <ul class="findings-list">
        <li 
          *ngFor="let insight of insights" 
          class="finding-item"
          [ngClass]="insight.type">
          <span class="finding-icon">{{ insight.icon }}</span>
          <strong>{{ insight.title }}:</strong> {{ insight.description }}
        </li>
      </ul>
    </section>

    <!-- ========== CATEGOR√çAS ========== -->
    <section class="report-section" *ngIf="categories && categories.length > 0">
      <h3>üìã An√°lisis por Categor√≠as</h3>
      
      <div class="categories-grid">
        <div *ngFor="let category of categories" class="category-card">
          <div class="category-header">
            <h4>{{ category.name }}</h4>
            <span 
              class="category-score"
              [ngClass]="getScoreClass(category.score)"
              [style.background]="getScoreColor(category.score) + '20'"
              [style.color]="getScoreColor(category.score)">
              {{ formatPercentage(category.score) }}
            </span>
          </div>
          
          <div class="category-bar">
            <div 
              class="category-fill"
              [ngClass]="getScoreClass(category.score)"
              [style.width]="formatPercentage(category.score)"
              [style.background]="getScoreColor(category.score)">
            </div>
          </div>
          
          <p class="category-description">{{ category.description }}</p>
        </div>
      </div>
    </section>

    <!-- ========== RECOMENDACIONES ========== -->
    <section class="report-section" *ngIf="recommendations && recommendations.length > 0">
      <h3>üí° Recomendaciones</h3>
      
      <div class="recommendations-grid">
        <div 
          *ngFor="let rec of recommendations"
          class="recommendation-card"
          [ngClass]="rec.category">
          <h4>{{ rec.category === 'potenciar' ? 'üöÄ' : rec.category === 'mejorar' ? 'üîß' : 'üëÅÔ∏è' }} {{ rec.title }}</h4>
          <ul>
            <li *ngFor="let item of rec.items">{{ item }}</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ========== PALABRAS M√ÅS COMUNES ========== -->
    <section class="report-section" *ngIf="topWords && topWords.length > 0">
      <h3>üí¨ Palabras M√°s Mencionadas</h3>
      
      <div class="words-cloud">
        <span 
          *ngFor="let word of topWords"
          class="word-tag"
          [style.fontSize.px]="word.size">
          {{ word.text }}
        </span>
      </div>
    </section>

    <!-- ========== CONCLUSIONES ========== -->
    <section class="report-section">
      <h3>üìù Conclusiones</h3>
      
      <div class="section-content conclusion">
        <p>
          La UNMSM mantiene una imagen <strong>{{ summary.general_perception }}</strong> 
          en redes sociales, respaldada por la calidad de su planta docente y logros acad√©micos. 
          Se recomienda mantener el foco en la comunicaci√≥n de estos aspectos mientras se trabaja en 
          las √°reas de mejora identificadas.
        </p>
        
        <p>
          El an√°lisis revela que la comunidad universitaria valora especialmente la excelencia acad√©mica, 
          la infraestructura y las oportunidades de investigaci√≥n. 
          Con un {{ formatPercentage(positivePercentage) }} de comentarios positivos, 
          la instituci√≥n demuestra una s√≥lida reputaci√≥n en el entorno digital.
        </p>
        
        <p *ngIf="reportData && reportData.best_day">
          Los mejores resultados de engagement se observan los d√≠as <strong>{{ reportData.best_day }}</strong>, 
          particularmente en el horario de <strong>{{ reportData.best_time }}</strong>.
        </p>
      </div>
    </section>

    <!-- Footer -->
    <div class="report-footer">
      <div class="footer-info">
        <p><strong>Metodolog√≠a:</strong> An√°lisis de sentimientos mediante NLP con modelo RandomForest</p>
        <p><strong>Fuente de datos:</strong> Instagram @unmsm_oficial</p>
        <p><strong>Per√≠odo:</strong> {{ getPeriodDescription() }}</p>
        <p><strong>Total comentarios analizados:</strong> {{ totalComments }}</p>
        <p><strong>Confianza del modelo:</strong> {{ formatPercentage(modelConfidence) }}</p>
        <p><strong>Generado por:</strong> Sistema de An√°lisis de Sentimientos UNMSM</p>
      </div>
    </div>

  </div>

</div>